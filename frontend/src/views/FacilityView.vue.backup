<template>
  <div class="min-h-screen bg-gray-100">
    <Navigation />
    <div class="p-4 lg:p-5 max-w-7xl mx-auto">
      <div class="flex flex-col lg:flex-row justify-between items-center mb-6 lg:mb-8">
        <h2 class="text-xl lg:text-2xl font-semibold text-gray-800 mb-4 lg:mb-0">
          üè¢ Qu·∫£n l√Ω C∆° s·ªü v·∫≠t ch·∫•t
        </h2>
        <div class="flex flex-wrap gap-2 justify-center lg:justify-end">
          <button @click="showMaintenanceSchedule = true" class="btn-primary text-xs lg:text-sm px-3 lg:px-4 py-2">
            üìÖ L·ªãch b·∫£o tr√¨
          </button>
          <button @click="showCreateForm = true" class="btn-success text-xs lg:text-sm px-3 lg:px-4 py-2">
            + Th√™m t√†i s·∫£n
          </button>
        </div>
      </div>

      <div v-if="loading" class="text-center py-10 text-gray-600 text-lg">ƒêang t·∫£i...</div>
      <div v-if="error" class="text-center py-10 text-red-600 bg-red-50 border border-red-200 rounded-lg">{{ error }}</div>

      <div class="flex flex-col gap-3 mb-5">
        <input 
          v-model="searchQuery" 
          type="text" 
          placeholder="T√¨m ki·∫øm..." 
          class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
          @input="searchWithFilters" 
        />
        <div class="grid grid-cols-1 gap-3">
          <select v-model="filterType" class="p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500" @change="searchWithFilters">
            <option value="">T·∫•t c·∫£ lo·∫°i</option>
            <option value="B√†n gh·∫ø">B√†n gh·∫ø</option>
            <option value="M√°y m√≥c">M√°y m√≥c</option>
            <option value="D·ª•ng c·ª•">D·ª•ng c·ª•</option>
            <option value="ƒêi·ªán t·ª≠">ƒêi·ªán t·ª≠</option>
            <option value="Kh√°c">Kh√°c</option>
          </select>
          <select v-model="filterStatus" class="p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500" @change="searchWithFilters">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="ƒêang s·ª≠ d·ª•ng">ƒêang s·ª≠ d·ª•ng</option>
            <option value="H·ªèng">H·ªèng</option>
            <option value="ƒêang s·ª≠a">ƒêang s·ª≠a</option>
            <option value="Ng·ª´ng s·ª≠ d·ª•ng">Ng·ª´ng s·ª≠ d·ª•ng</option>
            <option value="Thanh l√Ω">Thanh l√Ω</option>
          </select>
          <select v-model="filterArea" class="p-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500" @change="searchWithFilters">
            <option value="">T·∫•t c·∫£ khu v·ª±c</option>
            <option value="Ph√≤ng kh√°ch">Ph√≤ng kh√°ch</option>
            <option value="B·∫øp">B·∫øp</option>
            <option value="Qu·∫ßy bar">Qu·∫ßy bar</option>
            <option value="Kho">Kho</option>
            <option value="VƒÉn ph√≤ng">VƒÉn ph√≤ng</option>
            <option value="Kh√°c">Kh√°c</option>
          </select>
          <button @click="searchWithFilters" class="btn-primary text-base px-4 py-3">
            üîç T√¨m ki·∫øm
          </button>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <button @click="generateAssetReport" class="btn-secondary text-sm px-3 py-2">üìà B√°o c√°o</button>
          <button @click="showMaintenanceDue" class="btn-danger text-sm px-3 py-2">‚ö†Ô∏è ƒê·∫øn h·∫°n</button>
          <button @click="showStatusDashboard" class="btn-warning text-sm px-3 py-2">üìä Tr·∫°ng th√°i</button>
          <button @click="showIssueReports" class="btn-secondary text-sm px-3 py-2">üìù S·ª± c·ªë</button>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-4">
        <div v-for="item in filteredItems" :key="item.id" class="bg-white rounded-xl p-4 shadow-md">
          <!-- Facility Header -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" :class="getTypeColor(item.type)">
                {{ getTypeIcon(item.type) }}
              </div>
              <div>
                <h4 class="font-bold text-gray-800 text-lg">{{ item.name }}</h4>
                <p class="text-sm text-gray-500">{{ item.area }}</p>
              </div>
            </div>
            <div class="text-right">
              <span class="px-3 py-1 rounded-full text-xs font-medium" :class="getStatusBadge(item.status)">
                {{ item.status }}
              </span>
            </div>
          </div>

          <!-- Facility Info Grid -->
          <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="text-gray-500 text-xs mb-1">Lo·∫°i</div>
              <div class="font-medium text-gray-800">{{ item.type }}</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="text-gray-500 text-xs mb-1">S·ªë l∆∞·ª£ng</div>
              <div class="font-medium text-gray-800">{{ item.quantity }}</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="text-gray-500 text-xs mb-1">Ng√†y mua</div>
              <div class="font-medium text-gray-800">{{ formatDate(item.purchase_date) }}</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3" v-if="item.cost">
              <div class="text-gray-500 text-xs mb-1">Gi√° tr·ªã</div>
              <div class="font-medium text-gray-800">{{ formatPrice(item.cost) }}</div>
            </div>
          </div>

          <!-- Quick Actions Grid -->
          <div class="grid grid-cols-2 gap-2 mb-3">
            <button @click="showMaintenance(item)" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-3 rounded-xl text-sm font-medium transition-colors flex items-center justify-center space-x-2">
              <span>üîß</span>
              <span>B·∫£o tr√¨</span>
            </button>
            <button @click="showStatusUpdate(item)" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-xl text-sm font-medium transition-colors flex items-center justify-center space-x-2">
              <span>üîÑ</span>
              <span>Tr·∫°ng th√°i</span>
            </button>
          </div>

          <!-- More Actions Toggle -->
          <button @click="item.showMore = !item.showMore" class="w-full py-2 text-blue-600 text-sm font-medium border border-blue-200 rounded-lg hover:bg-blue-50 transition-colors">
            {{ item.showMore ? '‚ñ≤ ·∫®n b·ªõt' : '‚ñº Th√™m t√πy ch·ªçn' }}
          </button>

          <!-- Extended Actions -->
          <div v-if="item.showMore" class="grid grid-cols-2 gap-2 mt-3">
            <button @click="editItem(item)" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
              üìù S·ª≠a
            </button>
            <button @click="reportIssue(item)" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
              ‚ö†Ô∏è B√°o h·ªèng
            </button>
            <button @click="showHistory(item)" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
              üìà L·ªãch s·ª≠
            </button>
            <button @click="moveAsset(item)" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
              üöö Di chuy·ªÉn
            </button>
            <button @click="scheduleMaintenanceForItem(item)" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
              üìÖ L√™n l·ªãch
            </button>
            <button @click="showStatusHistory(item)" class="bg-teal-500 hover:bg-teal-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors">
              üìÖ L·ªãch s·ª≠ TT
            </button>
          </div>
        </div>
      </div>

      <!-- Create/Edit Modal -->
      <div v-if="showCreateForm || editingItem" class="modal">
        <div class="modal-content">
          <h3>{{ editingItem ? 'S·ª≠a t√†i s·∫£n' : 'Th√™m t√†i s·∫£n m·ªõi' }}</h3>
          <form @submit.prevent="saveItem">
            <div class="form-group">
              <label>T√™n t√†i s·∫£n *</label>
              <input v-model="form.name" type="text" required />
            </div>
            <div class="form-group">
              <label>Lo·∫°i *</label>
              <select v-model="form.type" required>
                <option value="">Ch·ªçn lo·∫°i</option>
                <option value="B√†n gh·∫ø">B√†n gh·∫ø</option>
                <option value="M√°y m√≥c">M√°y m√≥c</option>
                <option value="D·ª•ng c·ª•">D·ª•ng c·ª•</option>
                <option value="ƒêi·ªán t·ª≠">ƒêi·ªán t·ª≠</option>
                <option value="Kh√°c">Kh√°c</option>
              </select>
            </div>
            <div class="form-group">
              <label>Khu v·ª±c *</label>
              <select v-model="form.area" required>
                <option value="">Ch·ªçn khu v·ª±c</option>
                <option value="Ph√≤ng kh√°ch">Ph√≤ng kh√°ch</option>
                <option value="B·∫øp">B·∫øp</option>
                <option value="Qu·∫ßy bar">Qu·∫ßy bar</option>
                <option value="Kho">Kho</option>
                <option value="VƒÉn ph√≤ng">VƒÉn ph√≤ng</option>
                <option value="Kh√°c">Kh√°c</option>
              </select>
            </div>
            <div class="form-group">
              <label>S·ªë l∆∞·ª£ng *</label>
              <input v-model.number="form.quantity" type="number" min="1" required />
            </div>
            <div class="form-group">
              <label>Tr·∫°ng th√°i *</label>
              <select v-model="form.status" required>
                <option value="ƒêang s·ª≠ d·ª•ng">ƒêang s·ª≠ d·ª•ng</option>
                <option value="H·ªèng">H·ªèng</option>
                <option value="ƒêang s·ª≠a">ƒêang s·ª≠a</option>
                <option value="Ng·ª´ng s·ª≠ d·ª•ng">Ng·ª´ng s·ª≠ d·ª•ng</option>
                <option value="Thanh l√Ω">Thanh l√Ω</option>
              </select>
            </div>
            <div class="form-group">
              <label>Ng√†y mua</label>
              <input v-model="form.purchase_date" type="date" />
            </div>
            <div class="form-group">
              <label>Chi ph√≠ (VNƒê)</label>
              <input v-model.number="form.cost" type="number" min="0" />
            </div>
            <div class="form-group">
              <label>Nh√† cung c·∫•p</label>
              <input v-model="form.supplier" type="text" />
            </div>
            <div class="form-group">
              <label>Ghi ch√∫</label>
              <textarea v-model="form.notes" rows="3"></textarea>
            </div>
            <div class="form-group" v-if="editingItem">
              <label>L√Ω do thay ƒë·ªïi</label>
              <textarea v-model="form.change_reason" rows="2" placeholder="Nh·∫≠p l√Ω do c·∫≠p nh·∫≠t th√¥ng tin..."></textarea>
            </div>
            <div class="form-actions">
              <button type="button" @click="cancelEdit" class="btn-cancel">H·ªßy</button>
              <button type="submit" class="btn-save">{{ editingItem ? 'C·∫≠p nh·∫≠t' : 'Th√™m' }}</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Maintenance Modal -->
      <div v-if="maintenanceItem" class="modal">
        <div class="modal-content maintenance-modal">
          <h3>üîß B·∫£o tr√¨: {{ maintenanceItem.name }}</h3>
          
          <div class="maintenance-tabs">
            <button @click="maintenanceTab = 'history'" :class="{active: maintenanceTab === 'history'}">L·ªãch s·ª≠</button>
            <button @click="maintenanceTab = 'schedule'" :class="{active: maintenanceTab === 'schedule'}">L√™n l·ªãch</button>
            <button @click="maintenanceTab = 'costs'" :class="{active: maintenanceTab === 'costs'}">Chi ph√≠</button>
          </div>
          
          <!-- Maintenance History Tab -->
          <div v-if="maintenanceTab === 'history'" class="tab-content">
            <div class="maintenance-summary">
              <div class="summary-stats">
                <div class="stat-item">
                  <span class="stat-value">{{ maintenanceStats.total }}</span>
                  <span class="stat-label">T·ªïng s·ªë l·∫ßn</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ formatPrice(maintenanceStats.totalCost) }}</span>
                  <span class="stat-label">T·ªïng chi ph√≠</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ maintenanceStats.avgInterval }}</span>
                  <span class="stat-label">Chu k·ª≥ TB (ng√†y)</span>
                </div>
              </div>
            </div>
            
            <div v-if="maintenanceRecords.length === 0" class="no-data">Ch∆∞a c√≥ l·ªãch s·ª≠ b·∫£o tr√¨</div>
            <div v-else class="maintenance-list">
              <div v-for="record in maintenanceRecords" :key="record.id" class="maintenance-item" 
                   :class="'type-' + record.type">
                <div class="maintenance-header">
                  <div class="maintenance-type">
                    <span class="type-badge" :class="'type-' + record.type">
                      {{ getMaintenanceTypeText(record.type) }}
                    </span>
                    <span class="maintenance-date">{{ formatDate(record.date) }}</span>
                  </div>
                  <div class="maintenance-cost">{{ formatPrice(record.cost) }}</div>
                </div>
                
                <div class="maintenance-content">
                  <p><strong>M√¥ t·∫£:</strong> {{ record.description }}</p>
                  <p v-if="record.vendor"><strong>ƒê∆°n v·ªã:</strong> {{ record.vendor }}</p>
                  <p v-if="record.technician"><strong>K·ªπ thu·∫≠t vi√™n:</strong> {{ record.technician }}</p>
                  <p><strong>Ng∆∞·ªùi th·ª±c hi·ªán:</strong> {{ record.performed_by }}</p>
                  <p v-if="record.duration"><strong>Th·ªùi gian:</strong> {{ record.duration }} gi·ªù</p>
                  <p v-if="record.parts_used"><strong>Li·ªáu ki·ªán:</strong> {{ record.parts_used }}</p>
                </div>
                
                <div v-if="record.notes" class="maintenance-notes">
                  <strong>Ghi ch√∫:</strong> {{ record.notes }}
                </div>
                
                <div class="maintenance-actions">
                  <button @click="editMaintenanceRecord(record)" class="btn-edit-maintenance">üìù S·ª≠a</button>
                  <button @click="duplicateMaintenanceRecord(record)" class="btn-duplicate">üìã Sao ch√©p</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Schedule Tab -->
          <div v-if="maintenanceTab === 'schedule'" class="tab-content">
            <div class="next-maintenance-info">
              <h4>B·∫£o tr√¨ ti·∫øp theo</h4>
              <p v-if="nextMaintenanceDate">
                D·ª± ki·∫øn: <strong>{{ formatDate(nextMaintenanceDate) }}</strong>
                (c√≤n {{ getDaysUntil(nextMaintenanceDate) }} ng√†y)
              </p>
              <p v-else>Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨ ti·∫øp theo</p>
            </div>
            
            <button @click="showMaintenanceForm = true" class="btn-primary">+ L√™n l·ªãch b·∫£o tr√¨ m·ªõi</button>
          </div>
          
          <!-- Costs Tab -->
          <div v-if="maintenanceTab === 'costs'" class="tab-content">
            <div class="cost-analysis">
              <div class="cost-chart-placeholder">
                <h4>Ph√¢n t√≠ch chi ph√≠ b·∫£o tr√¨</h4>
                <div class="cost-breakdown">
                  <div class="cost-item">
                    <span>B·∫£o tr√¨ ƒë·ªãnh k·ª≥:</span>
                    <span>{{ formatPrice(maintenanceStats.scheduledCost) }}</span>
                  </div>
                  <div class="cost-item">
                    <span>S·ª≠a ch·ªØa ph√°t sinh:</span>
                    <span>{{ formatPrice(maintenanceStats.emergencyCost) }}</span>
                  </div>
                  <div class="cost-item total">
                    <span>T·ªïng c·ªông:</span>
                    <span>{{ formatPrice(maintenanceStats.totalCost) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="form-actions">
            <button @click="closeMaintenance" class="btn-cancel">ƒê√≥ng</button>
          </div>
        </div>
      </div>

      <!-- Enhanced Maintenance Form Modal -->
      <div v-if="showMaintenanceForm" class="modal">
        <div class="modal-content">
          <h3>{{ editingMaintenance ? 'S·ª≠a b·∫£o tr√¨' : 'Th√™m b·∫£o tr√¨ m·ªõi' }}</h3>
          <form @submit.prevent="saveMaintenanceRecord">
            <div class="form-group">
              <label>Lo·∫°i b·∫£o tr√¨ *</label>
              <select v-model="maintenanceForm.type" required>
                <option value="scheduled">ƒê·ªãnh k·ª≥</option>
                <option value="preventive">Ph√≤ng ng·ª´a</option>
                <option value="corrective">S·ª≠a ch·ªØa</option>
                <option value="emergency">Kh·∫©n c·∫•p</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>M√¥ t·∫£ c√¥ng vi·ªác *</label>
              <textarea v-model="maintenanceForm.description" required rows="3" 
                       placeholder="M√¥ t·∫£ chi ti·∫øt c√¥ng vi·ªác b·∫£o tr√¨..."></textarea>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Ng√†y th·ª±c hi·ªán *</label>
                <input v-model="maintenanceForm.date" type="date" required />
              </div>
              <div class="form-group">
                <label>Th·ªùi gian (gi·ªù)</label>
                <input v-model.number="maintenanceForm.duration" type="number" min="0.5" step="0.5" />
              </div>
            </div>
            
            <div class="form-group">
              <label>ƒê∆°n v·ªã th·ª±c hi·ªán</label>
              <select v-model="maintenanceForm.vendor_type">
                <option value="internal">N·ªôi b·ªô</option>
                <option value="external">B√™n ngo√†i</option>
              </select>
            </div>
            
            <div v-if="maintenanceForm.vendor_type === 'external'" class="form-group">
              <label>T√™n ƒë∆°n v·ªã</label>
              <input v-model="maintenanceForm.vendor" type="text" placeholder="T√™n c√¥ng ty/th·ª£ s·ª≠a ch·ªØa" />
            </div>
            
            <div v-if="maintenanceForm.vendor_type === 'internal'" class="form-group">
              <label>Nh√¢n vi√™n th·ª±c hi·ªán</label>
              <input v-model="maintenanceForm.technician" type="text" placeholder="T√™n nh√¢n vi√™n" />
            </div>
            
            <div class="form-group">
              <label>Chi ph√≠ (VNƒê)</label>
              <input v-model.number="maintenanceForm.cost" type="number" min="0" />
            </div>
            
            <div class="form-group">
              <label>Li·ªáu ki·ªán s·ª≠ d·ª•ng</label>
              <textarea v-model="maintenanceForm.parts_used" rows="2" 
                       placeholder="Danh s√°ch li·ªáu ki·ªán, ph·ª• t√πng ƒë√£ thay th·∫ø..."></textarea>
            </div>
            
            <div class="form-group">
              <label>Ghi ch√∫</label>
              <textarea v-model="maintenanceForm.notes" rows="2" 
                       placeholder="Ghi ch√∫ th√™m v·ªÅ qu√° tr√¨nh b·∫£o tr√¨..."></textarea>
            </div>
            
            <div class="form-actions">
              <button type="button" @click="closeMaintenanceForm" class="btn-cancel">H·ªßy</button>
              <button type="submit" class="btn-save">{{ editingMaintenance ? 'C·∫≠p nh·∫≠t' : 'L∆∞u' }}</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Add Maintenance Modal -->
      <div v-if="showAddMaintenance" class="modal">
        <div class="modal-content">
          <h3>Th√™m b·∫£o tr√¨</h3>
          <form @submit.prevent="saveMaintenance">
            <div class="form-group">
              <label>Lo·∫°i *</label>
              <select v-model="maintenanceForm.type" required>
                <option value="scheduled">ƒê·ªãnh k·ª≥</option>
                <option value="emergency">Ph√°t sinh</option>
              </select>
            </div>
            <div class="form-group">
              <label>M√¥ t·∫£ *</label>
              <textarea v-model="maintenanceForm.description" required rows="3"></textarea>
            </div>
            <div class="form-group">
              <label>Chi ph√≠ (VNƒê)</label>
              <input v-model.number="maintenanceForm.cost" type="number" min="0" />
            </div>
            <div class="form-group">
              <label>ƒê∆°n v·ªã s·ª≠a ch·ªØa</label>
              <input v-model="maintenanceForm.vendor" type="text" />
            </div>
            <div class="form-group">
              <label>Ng√†y th·ª±c hi·ªán</label>
              <input v-model="maintenanceForm.date" type="date" />
            </div>
            <div class="form-actions">
              <button type="button" @click="showAddMaintenance = false" class="btn-cancel">H·ªßy</button>
              <button type="submit" class="btn-save">L∆∞u</button>
            </div>
          </form>
        </div>
      </div>
      <!-- Maintenance Schedule Modal -->
      <div v-if="showMaintenanceSchedule" class="modal">
        <div class="modal-content schedule-modal">
          <h3>üìÖ L·ªãch B·∫£o tr√¨</h3>
          <div class="schedule-tabs">
            <button @click="scheduleTab = 'scheduled'" :class="{active: scheduleTab === 'scheduled'}">L·ªãch h·∫πn</button>
            <button @click="scheduleTab = 'due'" :class="{active: scheduleTab === 'due'}">ƒê·∫øn h·∫°n</button>
            <button @click="scheduleTab = 'overdue'" :class="{active: scheduleTab === 'overdue'}">Qu√° h·∫°n</button>
          </div>
          
          <div v-if="scheduleTab === 'scheduled'" class="schedule-content">
            <div class="schedule-header">
              <h4>C√°c l·ªãch b·∫£o tr√¨ ƒë√£ l√™n</h4>
              <button @click="showScheduleForm = true" class="btn-primary">+ L√™n l·ªãch m·ªõi</button>
            </div>
            <div v-if="scheduledTasks.length === 0" class="no-data">Ch∆∞a c√≥ l·ªãch b·∫£o tr√¨</div>
            <div v-else class="task-list">
              <div v-for="task in scheduledTasks" :key="task.id" class="task-item">
                <div class="task-info">
                  <h5>{{ task.facility_name }}</h5>
                  <p><strong>Lo·∫°i:</strong> {{ task.type === 'scheduled' ? 'ƒê·ªãnh k·ª≥' : 'Ph√°t sinh' }}</p>
                  <p><strong>M√¥ t·∫£:</strong> {{ task.description }}</p>
                  <p><strong>Ng√†y d·ª± ki·∫øn:</strong> {{ formatDate(task.scheduled_date) }}</p>
                  <p><strong>Tr·∫°ng th√°i:</strong> <span :class="'status-' + task.status">{{ getTaskStatusText(task.status) }}</span></p>
                </div>
                <div class="task-actions">
                  <button @click="completeTask(task)" class="btn-complete">‚úì Ho√†n th√†nh</button>
                  <button @click="editTask(task)" class="btn-edit">üìù S·ª≠a</button>
                </div>
              </div>
            </div>
          </div>
          
          <div v-if="scheduleTab === 'due'" class="schedule-content">
            <h4>B·∫£o tr√¨ ƒë·∫øn h·∫°n</h4>
            <div v-if="dueTasks.length === 0" class="no-data">Kh√¥ng c√≥ b·∫£o tr√¨ ƒë·∫øn h·∫°n</div>
            <div v-else class="task-list">
              <div v-for="task in dueTasks" :key="task.id" class="task-item due">
                <div class="task-info">
                  <h5>{{ task.facility_name }}</h5>
                  <p><strong>M√¥ t·∫£:</strong> {{ task.description }}</p>
                  <p><strong>Ng√†y ƒë·∫øn h·∫°n:</strong> {{ formatDate(task.scheduled_date) }}</p>
                </div>
                <div class="task-actions">
                  <button @click="completeTask(task)" class="btn-complete">‚úì Ho√†n th√†nh</button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="form-actions">
            <button @click="showMaintenanceSchedule = false" class="btn-cancel">ƒê√≥ng</button>
          </div>
        </div>
      </div>

      <!-- Schedule Form Modal -->
      <div v-if="showScheduleForm" class="modal">
        <div class="modal-content">
          <h3>L√™n l·ªãch b·∫£o tr√¨</h3>
          <form @submit.prevent="saveScheduledTask">
            <div class="form-group">
              <label>T√†i s·∫£n *</label>
              <select v-model="scheduleForm.facility_id" required>
                <option value="">Ch·ªçn t√†i s·∫£n</option>
                <option v-for="item in items" :key="item.id" :value="item.id">{{ item.name }} - {{ item.area }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>Lo·∫°i b·∫£o tr√¨ *</label>
              <select v-model="scheduleForm.type" required>
                <option value="scheduled">ƒê·ªãnh k·ª≥</option>
                <option value="preventive">Ph√≤ng ng·ª´a</option>
                <option value="corrective">S·ª≠a ch·ªØa</option>
              </select>
            </div>
            <div class="form-group">
              <label>M√¥ t·∫£ c√¥ng vi·ªác *</label>
              <textarea v-model="scheduleForm.description" required rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt c√¥ng vi·ªác b·∫£o tr√¨..."></textarea>
            </div>
            <div class="form-group">
              <label>Ng√†y d·ª± ki·∫øn *</label>
              <input v-model="scheduleForm.scheduled_date" type="date" required />
            </div>
            <div class="form-group">
              <label>Th·ªùi gian d·ª± ki·∫øn (gi·ªù)</label>
              <input v-model.number="scheduleForm.estimated_hours" type="number" min="0.5" step="0.5" />
            </div>
            <div class="form-group">
              <label>Chi ph√≠ d·ª± ki·∫øn (VNƒê)</label>
              <input v-model.number="scheduleForm.estimated_cost" type="number" min="0" />
            </div>
            <div class="form-group">
              <label>ƒê∆°n v·ªã th·ª±c hi·ªán</label>
              <input v-model="scheduleForm.assigned_to" type="text" placeholder="T√™n nh√¢n vi√™n ho·∫∑c ƒë∆°n v·ªã ngo√†i" />
            </div>
            <div class="form-group">
              <label>Ghi ch√∫</label>
              <textarea v-model="scheduleForm.notes" rows="2"></textarea>
            </div>
            <div class="form-actions">
              <button type="button" @click="showScheduleForm = false" class="btn-cancel">H·ªßy</button>
              <button type="submit" class="btn-save">L√™n l·ªãch</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Move Asset Modal -->
      <div v-if="movingAsset" class="modal">
        <div class="modal-content">
          <h3>üöö Di chuy·ªÉn t√†i s·∫£n: {{ movingAsset.name }}</h3>
          <p>Khu v·ª±c hi·ªán t·∫°i: <strong>{{ movingAsset.area }}</strong></p>
          <form @submit.prevent="saveMoveAsset">
            <div class="form-group">
              <label>Khu v·ª±c m·ªõi *</label>
              <select v-model="moveForm.new_area" required>
                <option value="">Ch·ªçn khu v·ª±c m·ªõi</option>
                <option value="Ph√≤ng kh√°ch">Ph√≤ng kh√°ch</option>
                <option value="B·∫øp">B·∫øp</option>
                <option value="Qu·∫ßy bar">Qu·∫ßy bar</option>
                <option value="Kho">Kho</option>
                <option value="VƒÉn ph√≤ng">VƒÉn ph√≤ng</option>
                <option value="Kh√°c">Kh√°c</option>
              </select>
            </div>
            <div class="form-group">
              <label>L√Ω do di chuy·ªÉn *</label>
              <textarea v-model="moveForm.reason" required rows="3" placeholder="Nh·∫≠p l√Ω do di chuy·ªÉn t√†i s·∫£n..."></textarea>
            </div>
            <div class="form-actions">
              <button type="button" @click="closeMoveAsset" class="btn-cancel">H·ªßy</button>
              <button type="submit" class="btn-save">Di chuy·ªÉn</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Issue Report Modal -->
      <div v-if="reportingIssue" class="modal">
        <div class="modal-content">
          <h3>‚ö†Ô∏è B√°o c√°o s·ª± c·ªë: {{ reportingIssue.name }}</h3>
          <form @submit.prevent="saveIssueReport">
            <div class="form-group">
              <label>Lo·∫°i s·ª± c·ªë *</label>
              <select v-model="issueForm.issue_type" required>
                <option value="">Ch·ªçn lo·∫°i s·ª± c·ªë</option>
                <option value="h∆∞ h·ªèng">ƒê·ªì b·ªã h∆∞ h·ªèng</option>
                <option value="kh√¥ng ho·∫°t ƒë·ªông">Kh√¥ng ho·∫°t ƒë·ªông</option>
                <option value="ho·∫°t ƒë·ªông b·∫•t th∆∞·ªùng">Ho·∫°t ƒë·ªông b·∫•t th∆∞·ªùng</option>
                <option value="an to√†n">V·∫•n ƒë·ªÅ an to√†n</option>
                <option value="kh√°c">Kh√°c</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>M·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng *</label>
              <select v-model="issueForm.severity" required>
                <option value="">Ch·ªçn m·ª©c ƒë·ªô</option>
                <option value="th·∫•p">Th·∫•p - Kh√¥ng ·∫£nh h∆∞·ªüng ho·∫°t ƒë·ªông</option>
                <option value="trung b√¨nh">Trung b√¨nh - ·∫¢nh h∆∞·ªüng m·ªôt ph·∫ßn</option>
                <option value="cao">Cao - ·∫¢nh h∆∞·ªüng nghi√™m tr·ªçng</option>
                <option value="kh·∫©n c·∫•p">Kh·∫©n c·∫•p - C·∫ßn x·ª≠ l√Ω ngay</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>M√¥ t·∫£ s·ª± c·ªë *</label>
              <textarea v-model="issueForm.description" required rows="4" 
                       placeholder="M√¥ t·∫£ chi ti·∫øt s·ª± c·ªë, tri·ªáu ch·ª©ng, th·ªùi ƒëi·ªÉm x·∫£y ra..."></textarea>
            </div>
            
            <div class="form-group">
              <label>V·ªã tr√≠ c·ª• th·ªÉ</label>
              <input v-model="issueForm.location" type="text" 
                     placeholder="V√≠ d·ª•: G√≥c ph·∫£i qu·∫ßy bar, c·∫°nh c·ª≠a s·ªï..." />
            </div>
            
            <div class="form-group">
              <label>H√¨nh ·∫£nh mi·ªÖn h·ªça</label>
              <input type="file" @change="handleImageUpload" accept="image/*" multiple />
              <small>C√≥ th·ªÉ ch·ªçn nhi·ªÅu h√¨nh ·∫£nh</small>
            </div>
            
            <div class="form-actions">
              <button type="button" @click="closeIssueReport" class="btn-cancel">H·ªßy</button>
              <button type="submit" class="btn-save">G·ª≠i b√°o c√°o</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Issue Reports List Modal -->
      <div v-if="showIssueReportsModal" class="modal">
        <div class="modal-content reports-modal">
          <h3>üìù B√°o c√°o S·ª± c·ªë</h3>
          
          <div v-if="issueReports.length === 0" class="no-data">Kh√¥ng c√≥ b√°o c√°o s·ª± c·ªë</div>
          <div v-else class="issue-reports-list">
            <div v-for="report in issueReports" :key="report.id" class="issue-report-item">
              <div class="report-header">
                <h5>{{ report.facility_name }}</h5>
                <span class="severity-badge" :class="'severity-' + report.severity">
                  {{ getSeverityText(report.severity) }}
                </span>
              </div>
              
              <div class="report-content">
                <p><strong>Lo·∫°i:</strong> {{ report.issue_type }}</p>
                <p><strong>M√¥ t·∫£:</strong> {{ report.description }}</p>
                <p><strong>Ng∆∞·ªùi b√°o c√°o:</strong> {{ report.reported_by }}</p>
                <p><strong>Th·ªùi gian:</strong> {{ formatDateTime(report.reported_at) }}</p>
              </div>
              
              <div class="report-actions">
                <button @click="updateReportStatus(report.id, 'resolved')" class="btn-resolve">Gi·∫£i quy·∫øt</button>
              </div>
            </div>
          </div>
          
          <div class="form-actions">
            <button @click="showIssueReportsModal = false" class="btn-cancel">ƒê√≥ng</button>
          </div>
        </div>
      </div>

      <!-- Status Update Modal -->
      <div v-if="statusUpdateItem" class="modal">
        <div class="modal-content">
          <h3>üîÑ C·∫≠p nh·∫≠t tr·∫°ng th√°i: {{ statusUpdateItem.name }}</h3>
          <form @submit.prevent="saveStatusUpdate">
            <div class="form-group">
              <label>Tr·∫°ng th√°i m·ªõi *</label>
              <select v-model="statusForm.status" required>
                <option value="ƒêang s·ª≠ d·ª•ng">ƒêang s·ª≠ d·ª•ng</option>
                <option value="H·ªèng">H·ªèng</option>
                <option value="ƒêang s·ª≠a">ƒêang s·ª≠a</option>
                <option value="Ng·ª´ng s·ª≠ d·ª•ng">Ng·ª´ng s·ª≠ d·ª•ng</option>
                <option value="Thanh l√Ω">Thanh l√Ω</option>
              </select>
            </div>
            <div class="form-group">
              <label>Ghi ch√∫</label>
              <textarea v-model="statusForm.notes" rows="3" placeholder="L√Ω do thay ƒë·ªïi tr·∫°ng th√°i..."></textarea>
            </div>
            <div class="form-actions">
              <button type="button" @click="closeStatusUpdate" class="btn-cancel">H·ªßy</button>
              <button type="submit" class="btn-save">C·∫≠p nh·∫≠t</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Asset Report Modal -->
      <div v-if="showAssetReport" class="modal">
        <div class="modal-content report-modal">
          <h3>üìà B√°o c√°o T√†i s·∫£n</h3>
          <div class="report-summary">
            <div class="summary-card">
              <h4>T·ªïng quan</h4>
              <p>T·ªïng s·ªë t√†i s·∫£n: <strong>{{ assetReport.total }}</strong></p>
              <p>ƒêang s·ª≠ d·ª•ng: <strong>{{ assetReport.active }}</strong></p>
              <p>C·∫ßn b·∫£o tr√¨: <strong>{{ assetReport.needMaintenance }}</strong></p>
              <p>H·ªèng h√≥c: <strong>{{ assetReport.broken }}</strong></p>
            </div>
            <div class="summary-card">
              <h4>Theo khu v·ª±c</h4>
              <div v-for="(count, area) in assetReport.byArea" :key="area">
                {{ area }}: <strong>{{ count }}</strong>
              </div>
            </div>
            <div class="summary-card">
              <h4>Theo lo·∫°i</h4>
              <div v-for="(count, type) in assetReport.byType" :key="type">
                {{ type }}: <strong>{{ count }}</strong>
              </div>
            </div>
          </div>
          <div class="form-actions">
            <button @click="exportAssetReport" class="btn-export">üìé Xu·∫•t Excel</button>
            <button @click="showAssetReport = false" class="btn-cancel">ƒê√≥ng</button>
          </div>
        </div>
      </div>

      <!-- Status History Modal -->
      <div v-if="statusHistoryItem" class="modal">
        <div class="modal-content">
          <h3>üìÖ L·ªãch s·ª≠ Tr·∫°ng th√°i: {{ statusHistoryItem.name }}</h3>
          
          <div v-if="statusHistory.length === 0" class="no-data">Ch∆∞a c√≥ l·ªãch s·ª≠ thay ƒë·ªïi tr·∫°ng th√°i</div>
          <div v-else class="status-timeline">
            <div v-for="history in statusHistory" :key="history.id" class="timeline-item">
              <div class="timeline-marker" :style="{backgroundColor: getStatusColor(history.new_value)}"></div>
              <div class="timeline-content">
                <div class="status-change">
                  <span class="old-status" :class="'status-' + getStatusClass(history.old_value)">{{ history.old_value }}</span>
                  <span class="arrow">‚Üí</span>
                  <span class="new-status" :class="'status-' + getStatusClass(history.new_value)">{{ history.new_value }}</span>
                </div>
                <div class="change-details">
                  <p><strong>M√¥ t·∫£:</strong> {{ history.description }}</p>
                  <p><strong>Ng∆∞·ªùi th·ª±c hi·ªán:</strong> {{ history.username }}</p>
                  <p><strong>Th·ªùi gian:</strong> {{ formatDateTime(history.created_at) }}</p>
                </div>
              </div>
            </div>
          </div>
          
          <div class="form-actions">
            <button @click="closeStatusHistory" class="btn-cancel">ƒê√≥ng</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue'
import { useFacilityStore } from '../stores/facility'
import Navigation from '../components/Navigation.vue'

const facilityStore = useFacilityStore()

const showCreateForm = ref(false)
const editingItem = ref(null)
const maintenanceItem = ref(null)
const maintenanceRecords = ref([])
const showAddMaintenance = ref(false)
const searchQuery = ref('')
const filterType = ref('')
const filterStatus = ref('')
const filterArea = ref('')
const statusUpdateItem = ref(null)
const showAssetReport = ref(false)
const assetReport = ref({})

const statusHistoryItem = ref(null)
const statusHistory = ref([])
const showStatusDashboardModal = ref(false)
const statusSummary = ref({})
const statusAlerts = ref([])

const statusForm = ref({
  status: '', notes: '', damage_level: '', expected_completion: '', disposal_reason: ''
})

const showMaintenanceSchedule = ref(false)
const showScheduleForm = ref(false)
const scheduleTab = ref('scheduled')
const scheduledTasks = ref([])
const dueTasks = ref([])

const movingAsset = ref(null)
const moveForm = ref({ new_area: '', reason: '' })
const reportingIssue = ref(null)
const showIssueReportsModal = ref(false)
const issueReports = ref([])
const scheduleForm = ref({
  facility_id: '', type: 'scheduled', description: '', scheduled_date: '',
  estimated_hours: 0, estimated_cost: 0, assigned_to: '', notes: ''
})

const issueForm = ref({
  issue_type: '', severity: '', description: '', location: '', 
  occurred_at: '', images: [], actions_taken: ''
})

const form = ref({
  name: '', type: '', area: '', quantity: 1, status: 'ƒêang s·ª≠ d·ª•ng',
  purchase_date: '', cost: 0, supplier: '', notes: '', change_reason: ''
})

const maintenanceTab = ref('history')
const showMaintenanceForm = ref(false)
const editingMaintenance = ref(null)
const maintenanceStats = ref({})
const nextMaintenanceDate = ref(null)

const maintenanceForm = ref({
  type: 'scheduled', description: '', date: '', duration: 0, 
  vendor_type: 'internal', vendor: '', technician: '', 
  cost: 0, parts_used: '', notes: ''
})

const items = computed(() => facilityStore.items || [])
const loading = computed(() => facilityStore.loading)
const error = computed(() => facilityStore.error)

const filteredItems = computed(() => {
  let filtered = items.value
  if (searchQuery.value) {
    filtered = filtered.filter(item => 
      item.name.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
      item.type.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
      item.area.toLowerCase().includes(searchQuery.value.toLowerCase())
    )
  }
  if (filterType.value) {
    filtered = filtered.filter(item => item.type === filterType.value)
  }
  if (filterStatus.value) {
    filtered = filtered.filter(item => item.status === filterStatus.value)
  }
  if (filterArea.value) {
    filtered = filtered.filter(item => item.area === filterArea.value)
  }
  return filtered
})

// FR-FM-08: Search & Filter functionality
const searchWithFilters = async () => {
  const filters = {
    name: searchQuery.value || undefined,
    type: filterType.value || undefined,
    area: filterArea.value || undefined,
    status: filterStatus.value || undefined,
    limit: 50
  }
  
  const result = await facilityStore.searchFacilities(filters)
  // Update items with search results
  facilityStore.items = result.data || []
}

onMounted(async () => {
  await facilityStore.fetchFacilities()
  await loadMaintenanceData()
})

const loadMaintenanceData = async () => {
  try {
    scheduledTasks.value = await facilityStore.fetchScheduledMaintenance()
  } catch (error) {
    scheduledTasks.value = []
  }
  
  try {
    dueTasks.value = await facilityStore.fetchMaintenanceDue()
  } catch (error) {
    dueTasks.value = []
  }
}

const resetForm = () => {
  form.value = {
    name: '', type: '', area: '', quantity: 1, status: 'ƒêang s·ª≠ d·ª•ng',
    purchase_date: '', cost: 0, supplier: '', notes: '', change_reason: ''
  }
}

const saveItem = async () => {
  const itemData = { ...form.value }
  if (editingItem.value && form.value.change_reason) {
    itemData.change_log = {
      reason: form.value.change_reason,
      timestamp: new Date().toISOString(),
      user: 'current_user' // TODO: get from auth store
    }
  }
  
  const success = editingItem.value 
    ? await facilityStore.updateFacility(editingItem.value.id, itemData)
    : await facilityStore.createFacility(itemData)
  
  if (success) {
    cancelEdit()
  }
}

const editItem = (item) => {
  editingItem.value = item
  form.value = { ...item }
  showCreateForm.value = false
}

const cancelEdit = () => {
  showCreateForm.value = false
  editingItem.value = null
  resetForm()
}

const deleteItem = async (id) => {
  const item = items.value.find(i => i.id === id)
  if (item?.has_maintenance_history) {
    alert('Kh√¥ng th·ªÉ x√≥a t√†i s·∫£n ƒë√£ c√≥ l·ªãch s·ª≠ b·∫£o tr√¨. Ch·ªâ c√≥ th·ªÉ chuy·ªÉn sang tr·∫°ng th√°i "Ng·ª´ng s·ª≠ d·ª•ng".')
    return
  }
  
  if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i s·∫£n n√†y?')) {
    await facilityStore.deleteFacility(id)
  }
}

const showStatusUpdate = (item) => {
  statusUpdateItem.value = item
  statusForm.value = { status: item.status, notes: '' }
}

const closeStatusUpdate = () => {
  statusUpdateItem.value = null
  statusForm.value = { status: '', notes: '', damage_level: '', expected_completion: '', disposal_reason: '' }
}

const saveStatusUpdate = async () => {
  const statusData = {
    status: statusForm.value.status,
    notes: statusForm.value.notes,
    damage_level: statusForm.value.damage_level,
    expected_completion: statusForm.value.expected_completion,
    disposal_reason: statusForm.value.disposal_reason
  }
  
  const success = await facilityStore.updateStatusWithDetails(statusUpdateItem.value.id, statusData)
  if (success) {
    closeStatusUpdate()
  }
}

const generateAssetReport = () => {
  const report = {
    total: items.value.length,
    active: items.value.filter(i => i.status === 'ƒêang s·ª≠ d·ª•ng').length,
    needMaintenance: items.value.filter(i => i.status === 'ƒêang s·ª≠a').length,
    broken: items.value.filter(i => i.status === 'H·ªèng').length,
    byArea: {},
    byType: {}
  }
  
  items.value.forEach(item => {
    report.byArea[item.area] = (report.byArea[item.area] || 0) + 1
    report.byType[item.type] = (report.byType[item.type] || 0) + 1
  })
  
  assetReport.value = report
  showAssetReport.value = true
}

const scheduleMaintenanceForItem = (item) => {
  scheduleForm.value.facility_id = item.id
  showScheduleForm.value = true
}

const saveScheduledTask = async () => {
  const success = await facilityStore.scheduleMaintenanceTask(scheduleForm.value)
  if (success) {
    showScheduleForm.value = false
    scheduleForm.value = {
      facility_id: '', type: 'scheduled', description: '', scheduled_date: '',
      estimated_hours: 0, estimated_cost: 0, assigned_to: '', notes: ''
    }
    await loadMaintenanceData()
  }
}

const completeTask = async (task) => {
  if (confirm('ƒê√°nh d·∫•u nhi·ªám v·ª• n√†y ƒë√£ ho√†n th√†nh?')) {
    const success = await facilityStore.updateMaintenanceTask(task.id, { status: 'completed' })
    if (success) {
      await loadMaintenanceData()
    }
  }
}

const editTask = (task) => {
  scheduleForm.value = { ...task }
  showScheduleForm.value = true
}

const showMaintenanceDue = async () => {
  await loadMaintenanceData()
  scheduleTab.value = 'due'
  showMaintenanceSchedule.value = true
}

const moveAsset = (item) => {
  movingAsset.value = item
  moveForm.value = { new_area: '', reason: '' }
}

const closeMoveAsset = () => {
  movingAsset.value = null
  moveForm.value = { new_area: '', reason: '' }
}

const saveMoveAsset = async () => {
  const moveData = {
    area: moveForm.value.new_area,
    change_reason: `Di chuy·ªÉn t·ª´ ${movingAsset.value.area} ƒë·∫øn ${moveForm.value.new_area}: ${moveForm.value.reason}`
  }
  
  const success = await facilityStore.updateFacility(movingAsset.value.id, moveData)
  if (success) {
    closeMoveAsset()
  }
}
const getTaskStatusText = (status) => {
  const statusMap = {
    'pending': 'Ch·ªù th·ª±c hi·ªán',
    'in_progress': 'ƒêang th·ª±c hi·ªán', 
    'completed': 'Ho√†n th√†nh',
    'cancelled': 'ƒê√£ h·ªßy'
  }
  return statusMap[status] || status
}

const showStatusDashboard = async () => {
  statusSummary.value = calculateStatusSummary()
  statusAlerts.value = await facilityStore.fetchStatusAlerts()
  showStatusDashboardModal.value = true
}

const calculateStatusSummary = () => {
  const summary = {}
  items.value.forEach(item => {
    summary[item.status] = (summary[item.status] || 0) + 1
  })
  return summary
}

const getStatusPercentage = (count) => {
  return Math.round((count / items.value.length) * 100)
}

const getStatusIcon = (status) => {
  const icons = {
    'ƒêang s·ª≠ d·ª•ng': '‚úÖ',
    'H·ªèng': '‚ùå',
    'ƒêang s·ª≠a': 'üîß',
    'Ng·ª´ng s·ª≠ d·ª•ng': '‚è∏Ô∏è',
    'Thanh l√Ω': 'üóëÔ∏è'
  }
  return icons[status] || '‚ùì'
}

const showStatusHistory = async (item) => {
  console.log('showStatusHistory called with item:', item)
  statusHistoryItem.value = item
  try {
    const history = await facilityStore.fetchStatusHistory(item.id)
    console.log('Status history received:', history)
    statusHistory.value = history
  } catch (error) {
    console.error('Error fetching status history:', error)
    statusHistory.value = []
  }
}

const closeStatusHistory = () => {
  statusHistoryItem.value = null
  statusHistory.value = []
}

const onStatusChange = () => {
  statusForm.value.damage_level = ''
  statusForm.value.expected_completion = ''
  statusForm.value.disposal_reason = ''
}

const getNotesPlaceholder = (status) => {
  const placeholders = {
    'H·ªèng': 'M√¥ t·∫£ chi ti·∫øt t√¨nh tr·∫°ng h∆∞ h·ªèng...',
    'ƒêang s·ª≠a': 'Th√¥ng tin v·ªÅ qu√° tr√¨nh s·ª≠a ch·ªØa...',
    'Ng·ª´ng s·ª≠ d·ª•ng': 'L√Ω do ng·ª´ng s·ª≠ d·ª•ng...',
    'Thanh l√Ω': 'Chi ti·∫øt v·ªÅ vi·ªác thanh l√Ω...'
  }
  return placeholders[status] || 'L√Ω do thay ƒë·ªïi tr·∫°ng th√°i...'
}

const getStatusImpact = (status) => {
  const impacts = {
    'H·ªèng': 'T√†i s·∫£n s·∫Ω kh√¥ng th·ªÉ s·ª≠ d·ª•ng cho ƒë·∫øn khi ƒë∆∞·ª£c s·ª≠a ch·ªØa',
    'ƒêang s·ª≠a': 'T√†i s·∫£n t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng',
    'Ng·ª´ng s·ª≠ d·ª•ng': 'T√†i s·∫£n s·∫Ω ƒë∆∞·ª£c lo·∫°i kh·ªèi ho·∫°t ƒë·ªông',
    'Thanh l√Ω': 'T√†i s·∫£n s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn kh·ªèi h·ªá th·ªëng'
  }
  return impacts[status]
}

const getStatusAge = (lastChange) => {
  if (!lastChange) return ''
  const days = Math.floor((new Date() - new Date(lastChange)) / (1000 * 60 * 60 * 24))
  if (days === 0) return 'H√¥m nay'
  if (days === 1) return '1 ng√†y'
  return `${days} ng√†y`
}

const formatDateTime = (date) => {
  if (!date) return 'N/A'
  return new Date(date).toLocaleString('vi-VN')
}

const reportIssue = (item) => {
  reportingIssue.value = item
  issueForm.value = {
    issue_type: '', severity: '', description: '', location: '', 
    occurred_at: '', images: [], actions_taken: ''
  }
}

const closeIssueReport = () => {
  reportingIssue.value = null
  issueForm.value = {
    issue_type: '', severity: '', description: '', location: '', 
    occurred_at: '', images: [], actions_taken: ''
  }
}

const saveIssueReport = async () => {
  const reportData = {
    ...issueForm.value,
    facility_id: reportingIssue.value.id,
    facility_name: reportingIssue.value.name
  }
  
  const success = await facilityStore.createIssueReport(reportData)
  if (success) {
    closeIssueReport()
    alert('B√°o c√°o s·ª± c·ªë ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!')
  }
}

const handleImageUpload = (event) => {
  const files = Array.from(event.target.files)
  files.forEach(file => {
    if (file.type.startsWith('image/')) {
      const reader = new FileReader()
      reader.onload = (e) => {
        issueForm.value.images.push({
          file: file,
          preview: e.target.result,
          name: file.name
        })
      }
      reader.readAsDataURL(file)
    }
  })
}

const removeImage = (index) => {
  issueForm.value.images.splice(index, 1)
}

const showIssueReports = async () => {
  issueReports.value = await facilityStore.fetchIssueReports()
  showIssueReportsModal.value = true
}

const updateReportStatus = async (reportId, status) => {
  const success = await facilityStore.updateIssueReportStatus(reportId, status)
  if (success) {
    issueReports.value = await facilityStore.fetchIssueReports()
  }
}

const getSeverityText = (severity) => {
  const severityMap = {
    'th·∫•p': 'Th·∫•p',
    'trung b√¨nh': 'Trung b√¨nh',
    'cao': 'Cao',
    'kh·∫©n c·∫•p': 'Kh·∫©n c·∫•p'
  }
  return severityMap[severity] || severity
}

const getUrgencyText = (severity) => {
  const urgencyMap = {
    'th·∫•p': 'Kh√¥ng c·∫ßn gi·∫£i quy·∫øt ngay',
    'trung b√¨nh': 'N√™n gi·∫£i quy·∫øt trong ng√†y',
    'cao': 'C·∫ßn gi·∫£i quy·∫øt s·ªõm',
    'kh·∫©n c·∫•p': 'C·∫ßn gi·∫£i quy·∫øt ngay l·∫≠p t·ª©c'
  }
  return urgencyMap[severity] || ''
}

const showMaintenance = async (item) => {
  maintenanceItem.value = item
  try {
    maintenanceRecords.value = await facilityStore.fetchMaintenanceHistory(item.id)
  } catch (error) {
    maintenanceRecords.value = []
  }
  
  try {
    maintenanceStats.value = await facilityStore.fetchMaintenanceStats(item.id)
  } catch (error) {
    maintenanceStats.value = { total: 0, totalCost: 0, avgInterval: 0, scheduledCost: 0, emergencyCost: 0 }
  }
  
  try {
    nextMaintenanceDate.value = await facilityStore.fetchNextMaintenanceDate(item.id)
  } catch (error) {
    nextMaintenanceDate.value = null
  }
  
  maintenanceTab.value = 'history'
}

const closeMaintenance = () => {
  maintenanceItem.value = null
  maintenanceRecords.value = []
  showMaintenanceForm.value = false
  editingMaintenance.value = null
}

const closeMaintenanceForm = () => {
  showMaintenanceForm.value = false
  editingMaintenance.value = null
  maintenanceForm.value = {
    type: 'scheduled', description: '', date: '', duration: 0, 
    vendor_type: 'internal', vendor: '', technician: '', 
    cost: 0, parts_used: '', notes: ''
  }
}

const saveMaintenanceRecord = async () => {
  const record = {
    ...maintenanceForm.value,
    facility_id: maintenanceItem.value.id
  }
  
  const success = editingMaintenance.value
    ? await facilityStore.updateMaintenanceRecord(editingMaintenance.value.id, record)
    : await facilityStore.createMaintenanceRecord(record)
    
  if (success) {
    closeMaintenanceForm()
    maintenanceRecords.value = await facilityStore.fetchMaintenanceHistory(maintenanceItem.value.id)
    maintenanceStats.value = await facilityStore.fetchMaintenanceStats(maintenanceItem.value.id)
  }
}

const editMaintenanceRecord = (record) => {
  editingMaintenance.value = record
  maintenanceForm.value = { ...record }
  showMaintenanceForm.value = true
}

const duplicateMaintenanceRecord = (record) => {
  maintenanceForm.value = {
    ...record,
    date: '',
    cost: record.cost || 0
  }
  delete maintenanceForm.value.id
  showMaintenanceForm.value = true
}

const getMaintenanceTypeText = (type) => {
  const typeMap = {
    'scheduled': 'ƒê·ªãnh k·ª≥',
    'preventive': 'Ph√≤ng ng·ª´a', 
    'corrective': 'S·ª≠a ch·ªØa',
    'emergency': 'Kh·∫©n c·∫•p'
  }
  return typeMap[type] || type
}

const getDaysUntil = (date) => {
  if (!date) return 0
  const days = Math.ceil((new Date(date) - new Date()) / (1000 * 60 * 60 * 24))
  return Math.max(0, days)
}

const getStatusClass = (status) => {
  const statusMap = {
    'ƒêang s·ª≠ d·ª•ng': 'active',
    'H·ªèng': 'broken',
    'ƒêang s·ª≠a': 'repair',
    'Ng·ª´ng s·ª≠ d·ª•ng': 'inactive',
    'Thanh l√Ω': 'disposed'
  }
  return statusMap[status] || 'default'
}

const formatDate = (date) => {
  if (!date) return 'N/A'
  return new Date(date).toLocaleDateString('vi-VN')
}

const formatPrice = (price) => {
  if (!price) return '0 VNƒê'
  return new Intl.NumberFormat('vi-VN').format(price) + ' VNƒê'
}

const showHistory = async (item) => {
  const history = await facilityStore.fetchFacilityHistory(item.id)
  // TODO: Show history modal
  console.log('History for', item.name, history)
}

const getStatusColor = (status) => {
  const colorMap = {
    'ƒêang s·ª≠ d·ª•ng': '#27ae60',
    'H·ªèng': '#e74c3c',
    'ƒêang s·ª≠a': '#f39c12',
    'Ng·ª´ng s·ª≠ d·ª•ng': '#95a5a6',
    'Thanh l√Ω': '#7f8c8d'
  }
  return colorMap[status] || '#3498db'
}

const getTypeIcon = (type) => {
  const iconMap = {
    'B√†n gh·∫ø': 'ü™ë',
    'M√°y m√≥c': '‚öôÔ∏è',
    'D·ª•ng c·ª•': 'üîß',
    'ƒêi·ªán t·ª≠': 'üíª',
    'Kh√°c': 'üì¶'
  }
  return iconMap[type] || 'üì¶'
}

const getTypeColor = (type) => {
  const colorMap = {
    'B√†n gh·∫ø': 'bg-blue-100 text-blue-600',
    'M√°y m√≥c': 'bg-green-100 text-green-600',
    'D·ª•ng c·ª•': 'bg-yellow-100 text-yellow-600',
    'ƒêi·ªán t·ª≠': 'bg-purple-100 text-purple-600',
    'Kh√°c': 'bg-gray-100 text-gray-600'
  }
  return colorMap[type] || 'bg-gray-100 text-gray-600'
}

const getStatusBadge = (status) => {
  const badgeMap = {
    'ƒêang s·ª≠ d·ª•ng': 'bg-green-100 text-green-800',
    'H·ªèng': 'bg-red-100 text-red-800',
    'ƒêang s·ª≠a': 'bg-yellow-100 text-yellow-800',
    'Ng·ª´ng s·ª≠ d·ª•ng': 'bg-gray-100 text-gray-800',
    'Thanh l√Ω': 'bg-gray-100 text-gray-600'
  }
  return badgeMap[status] || 'bg-gray-100 text-gray-600'
}
</script>

<style scoped>
/* Modal styles */
.modal {
  @apply fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4;
}

.modal-content {
  @apply bg-white p-6 lg:p-8 rounded-xl w-full max-w-lg max-h-screen overflow-y-auto;
}

.modal-content h3 {
  @apply text-lg lg:text-xl font-semibold text-gray-800 mb-5 text-center;
}

.form-group {
  @apply mb-4;
}

.form-group label {
  @apply block mb-2 font-medium text-gray-700 text-sm;
}

.form-group input,
.form-group select,
.form-group textarea {
  @apply w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500;
}

.form-actions {
  @apply flex flex-col lg:flex-row gap-3 justify-end mt-6;
}

.form-actions button {
  @apply w-full lg:w-auto px-5 py-2 rounded-lg font-medium transition-colors duration-200;
}

.btn-save {
  @apply bg-green-600 text-white hover:bg-green-700;
}

.btn-cancel {
  @apply bg-gray-600 text-white hover:bg-gray-700;
}

/* Maintenance modal styles */
.maintenance-modal {
  @apply max-w-4xl;
}

.maintenance-tabs {
  @apply flex gap-1 mb-5;
}

.maintenance-tabs button {
  @apply px-4 py-2 border border-gray-300 bg-gray-100 cursor-pointer rounded-t-lg text-sm;
}

.maintenance-tabs button.active {
  @apply bg-blue-600 text-white border-blue-600;
}

.summary-stats {
  @apply grid grid-cols-1 lg:grid-cols-3 gap-4;
}

.stat-item {
  @apply text-center p-4 bg-gray-100 rounded-lg;
}

.stat-value {
  @apply block text-xl lg:text-2xl font-bold text-blue-600;
}

.stat-label {
  @apply text-xs text-gray-600;
}

.maintenance-list {
  @apply max-h-96 overflow-y-auto;
}

.maintenance-item {
  @apply bg-gray-100 p-4 rounded-lg mb-4 border-l-4;
}

.maintenance-item.type-scheduled {
  @apply border-green-500;
}

.maintenance-item.type-preventive {
  @apply border-blue-500;
}

.maintenance-item.type-corrective {
  @apply border-yellow-500;
}

.maintenance-item.type-emergency {
  @apply border-red-500;
}

.maintenance-header {
  @apply flex flex-col lg:flex-row justify-between items-start lg:items-center mb-3 gap-2;
}

.type-badge {
  @apply px-2 py-1 rounded-full text-xs font-bold;
}

.type-badge.type-scheduled {
  @apply bg-green-200 text-green-800;
}

.type-badge.type-preventive {
  @apply bg-blue-200 text-blue-800;
}

.type-badge.type-corrective {
  @apply bg-yellow-200 text-yellow-800;
}

.type-badge.type-emergency {
  @apply bg-red-200 text-red-800;
}

.maintenance-content p {
  @apply my-1 text-sm text-gray-600;
}

.maintenance-actions {
  @apply flex gap-2 mt-3 justify-center lg:justify-start;
}

.btn-edit-maintenance,
.btn-duplicate {
  @apply px-2 py-1 border-none rounded text-xs cursor-pointer;
}

.btn-edit-maintenance {
  @apply bg-yellow-500 text-gray-900;
}

.btn-duplicate {
  @apply bg-gray-600 text-white;
}

/* Timeline styles */
.status-timeline {
  @apply max-h-96 overflow-y-auto;
}

.timeline-item {
  @apply flex gap-4 mb-5;
}

.timeline-marker {
  @apply w-3 h-3 rounded-full mt-1 flex-shrink-0;
}

.timeline-content {
  @apply flex-1;
}

.status-change {
  @apply flex flex-wrap items-center gap-2 mb-3;
}

.old-status,
.new-status {
  @apply px-2 py-1 rounded-full text-xs font-bold;
}

.arrow {
  @apply text-gray-600;
}

.change-details p {
  @apply my-1 text-sm text-gray-600;
}

/* Form row styles */
.form-row {
  @apply grid grid-cols-1 lg:grid-cols-2 gap-4;
}

/* Loading and error states */
.loading,
.error,
.no-data {
  @apply text-center py-10 text-gray-600 text-base;
}

.error {
  @apply text-red-600 bg-red-50 border border-red-200 rounded-lg;
}

/* Task and report styles */
.task-list,
.issue-reports-list {
  @apply max-h-96 overflow-y-auto;
}

.task-item,
.issue-report-item {
  @apply bg-gray-100 p-4 rounded-lg mb-3 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-3;
}

.task-item.due {
  @apply border-l-4 border-red-500;
}

.task-info h5,
.report-header h5 {
  @apply m-0 mb-2 text-gray-800 font-medium;
}

.task-info p,
.report-content p {
  @apply my-1 text-sm text-gray-600;
}

.task-actions,
.report-actions {
  @apply flex gap-2 justify-center lg:justify-start;
}

.task-actions button,
.report-actions button {
  @apply px-3 py-1 border-none rounded text-xs cursor-pointer;
}

.severity-badge {
  @apply px-2 py-1 rounded-full text-xs font-bold;
}

.severity-th·∫•p {
  @apply bg-green-200 text-green-800;
}

.severity-trung-b√¨nh {
  @apply bg-yellow-200 text-yellow-800;
}

.severity-cao {
  @apply bg-red-200 text-red-800;
}

.severity-kh·∫©n-c·∫•p {
  @apply bg-red-300 text-red-900 animate-pulse;
}

.btn-resolve {
  @apply bg-green-600 text-white hover:bg-green-700;
}

/* Report summary styles */
.report-summary {
  @apply grid grid-cols-1 lg:grid-cols-3 gap-5 mb-5;
}

.summary-card {
  @apply bg-gray-100 p-4 rounded-lg border-l-4 border-blue-500;
}

.summary-card h4 {
  @apply m-0 mb-3 text-gray-800 font-medium;
}

.summary-card p,
.summary-card div {
  @apply my-1 text-gray-600;
}

/* Cost analysis */
.cost-analysis {
  @apply bg-gray-100 p-5 rounded-lg;
}

.cost-breakdown {
  @apply mt-4;
}

.cost-item {
  @apply flex justify-between py-2 border-b border-gray-300;
}

.cost-item.total {
  @apply font-bold border-t-2 border-blue-600 border-b-0;
}

.next-maintenance-info {
  @apply bg-blue-50 p-4 rounded-lg mb-5;
}

.next-maintenance-info h4 {
  @apply m-0 mb-3 text-blue-700;
}

@media (max-width: 1023px) {
  .modal-content {
    @apply max-w-full w-full max-h-full;
  }
  
  .maintenance-modal {
    @apply max-w-full;
  }
  
  .maintenance-tabs {
    @apply flex-wrap gap-1;
  }
  
  .maintenance-tabs button {
    @apply flex-1 min-w-20 px-2 text-xs;
  }
}
</style>
